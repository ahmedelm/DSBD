
function evaluate()

    

	%evaluate1('tv2007', 'p75x5x3', 'p7b', 'fc6');
	%evaluate1('tv2007', 'dsbdn6', 'p12b', 'fc6');
    %evaluate1('tv2007', 'dsbdn6', 'p12b', 'fc8');
	%evaluate1('tv2007', 'dsbdn6', 'p12b', 'prob');

	%evaluate1('tv2001', 'p75x5x3', 'p7b', 'fc6');
    %evaluate1('tv2001', 'dsbdn6', 'p12b', 'fc6');
    %evaluate1('tv2001', 'dsbdn6', 'p12b', 'fc8');
	%evaluate1('tv2001', 'dsbdn6', 'p12b', 'prob');
    
	%evaluate1('tv2001_v2', 'p75x5x3', 'p7b', 'fc6');
    %evaluate1('tv2001_v2', 'dsbdn6', 'p12b', 'fc6');
    %evaluate1('tv2001_v2', 'dsbdn6', 'p12b', 'fc8');
	%evaluate1('tv2001_v2', 'dsbdn6', 'p12b', 'prob');
    
    
	%evaluate1('tv2002', 'p75x5x3', 'p7b', 'fc6');
    %evaluate1('tv2002', 'dsbdn6', 'p12b', 'fc6');
    %evaluate1('tv2002', 'dsbdn6', 'p12b', 'fc8');
	%evaluate1('tv2002', 'dsbdn6', 'p12b', 'prob');
    
	%evaluate1('tv2003', 'p75x5x3', 'p7b', 'fc6');
    %evaluate1('tv2003', 'dsbdn6', 'p12b', 'fc6');
    %evaluate1('tv2003', 'dsbdn6', 'p12b', 'fc8');
	%evaluate1('tv2003', 'dsbdn6', 'p12b', 'prob');
    
	%evaluate1('tv2004', 'p75x5x3', 'p7b', 'fc6');
    %evaluate1('tv2004', 'dsbdn6', 'p12b', 'fc6');
    %evaluate1('tv2004', 'dsbdn6', 'p12b', 'fc8');
	%evaluate1('tv2004', 'dsbdn6', 'p12b', 'prob'); 
    
    %evaluate1('tv2006', 'dsbdn6', 'p12b', 'fc6');
    %evaluate1('tv2006', 'dsbdn6', 'p12b', 'fc8');
	%evaluate1('tv2006', 'dsbdn6', 'p12b', 'prob'); 
    
    %evaluate1('tv2001', 'n6real_only', 'p12b', 'prob');
    %evaluate1('tv2006', 'n6real_only', 'p12b', 'prob');
	%evaluate1('tv2007', 'n6real_only', 'p12b', 'prob'); 
     
    
    %evaluate1('tv2001', 'real_only', 'p12b', 'prob');
    %evaluate1('tv2006', 'real_only', 'p12b', 'prob');
	%evaluate1('tv2007', 'real_only', 'p12b', 'prob'); 
    
    %evaluate1('tv2001', 'bsreal_only', 'p12b', 'prob');
    %evaluate1('tv2006', 'bsreal_only', 'p12b', 'prob');
	%evaluate1('tv2007', 'bsreal_only', 'p12b', 'prob'); 
    
    %evaluate1('tv2001', 'dsbdn6nbs', 'p12b', 'prob');
    %evaluate1('tv2006', 'dsbdn6nbs', 'p12b', 'prob');
	%evaluate1('tv2007', 'dsbdn6nbs', 'p12b', 'prob'); 
    %evaluate1('tv2001_v2', 'dsbdn6nbs', 'p12b', 'prob');
    %evaluate1('tv2002', 'dsbdn6nbs', 'p12b', 'prob');
	%evaluate1('tv2003', 'dsbdn6nbs', 'p12b', 'prob'); 
	%evaluate1('tv2004', 'dsbdn6nbs', 'p12b', 'prob'); 
       
     
    %evaluate1('tv2001', 'dsbdn6nbs2', 'p12b', 'prob');
    %evaluate1('tv2006', 'dsbdn6nbs2', 'p12b', 'prob');
	%evaluate1('tv2007', 'dsbdn6nbs2', 'p12b', 'prob'); 
    %evaluate1('tv2001_v2', 'dsbdn6nbs2', 'p12b', 'prob');
    %evaluate1('tv2002', 'dsbdn6nbs2', 'p12b', 'prob');
	%evaluate1('tv2003', 'dsbdn6nbs2', 'p12b', 'prob'); 
	%evaluate1('tv2004', 'dsbdn6nbs2', 'p12b', 'prob'); 
      
    %evaluate1('tv2001_v2', 'dsbdn6nbs3', 'p12b', 'prob');     
    %evaluate1('tv2001', 'dsbdn6nbs3', 'p12b', 'prob');
    %evaluate1('tv2006', 'dsbdn6nbs3', 'p12b', 'prob');
	%evaluate1('tv2007', 'dsbdn6nbs3', 'p12b', 'prob'); 
    %evaluate1('tv2002', 'dsbdn6nbs3', 'p12b', 'prob');
	%evaluate1('tv2003', 'dsbdn6nbs3', 'p12b', 'prob'); 
	%evaluate1('tv2004', 'dsbdn6nbs3', 'p12b', 'prob'); 
           
    %evaluate1('tv2001_v2', 'synbs', 'p12b', 'prob');     
    %evaluate1('tv2001', 'synbs', 'p12b', 'prob');
    %evaluate1('tv2006', 'synbs', 'p12b', 'prob');
	%evaluate1('tv2007', 'synbs', 'p12b', 'prob'); 
    %evaluate1('tv2002', 'synbs', 'p12b', 'prob');
	%evaluate1('tv2003', 'synbs', 'p12b', 'prob'); 
	%evaluate1('tv2004', 'synbs', 'p12b', 'prob'); 
   	%evaluate1('tv2005', 'synbs', 'p12b', 'prob'); 
    
    %evaluate1('RAIDataset', 'synbs', 'p12b', 'prob'); 
    %evaluate1('RAIDataset', 'dsbdn6', 'p12b', 'prob'); 
    
    %evaluate1('rai', 'synbs', 'p12b', 'prob'); 
    %evaluate1('rai', 'dsbdn6', 'p12b', 'prob'); 

    %evaluate1('tv2007', 'p5', 'model');
    %evaluate1('tv2007', 'p6', 'model');
    %evaluate1('tv2001', 'p5', 'model');
    %evaluate1('tv2001', 'p6', 'model');
    %evaluate1('tv2007', 'p5', 'p6b');
    %evaluate1('tv2007', 'p6', 'p6b');
    %evaluate1('tv2001', 'p5', 'p6b');
    %evaluate1('tv2001', 'p6', 'p6b');
    %evaluate1('tv2001', 'p5_p6', 'p6b', 'prob');
	%evaluate1('tv2007', 'p5_p6', 'p6b', 'prob');

	%evaluate1('tv2001', 'p5_p6', 'p6b', 'fc6');
	%evaluate1('tv2007', 'p5_p6', 'p6b', 'fc6');
    
    %evaluate1('tv2001', 'p73x3x101', 'p7b', 'fc6');
	%evaluate1('tv2001', 'p73x5x101', 'p7b', 'fc6');
	
    %evaluate1('tv2007', 'p73x3x101', 'p7b', 'fc6');
	%evaluate1('tv2007', 'p73x5x101', 'p7b', 'fc6');
	%evaluate1('tvtransitions', 'p75x5x3', 'p7b', 'fc6');

	%evaluate1('tv2007', 'p75x5x3', 'p12b', 'fc6');
	%evaluate1('tv2001', 'p75x5x3', 'p12b', 'fc6');
	
	%evaluate1('tv2007', 'p125x5x3', 'p12b', 'fc6');
	%evaluate1('tv2007', 'p125x5x3', 'p12b', 'fc7');
	%evaluate1('tv2007', 'p125x5x3', 'p12b', 'fc8');
	%evaluate1('tv2001', 'p125x5x3', 'p12b', 'fc6');
	%evaluate1('tv2001', 'p125x5x3', 'p12b', 'fc7');
	%evaluate1('tv2001', 'p125x5x3', 'p12b', 'fc8');
	%evaluate1('tv2007', 'p145x5x3', 'p12b', 'fc6');
	%evaluate1('tv2007', 'p145x5x3', 'p12b', 'fc7');
	%evaluate1('tv2007', 'p145x5x3', 'p12b', 'fc8');
	%evaluate1('tv2001', 'p145x5x3', 'p12b', 'fc6');
	%evaluate1('tv2001', 'p145x5x3', 'p12b', 'fc7');
	%evaluate1('tv2001', 'p145x5x3', 'p12b', 'fc8');
	

	%evaluate1('tv2007', 'p12q1n2c1', 'p12b', 'pool5');
	%evaluate1('tv2007', 'p12q1n2c1', 'p12b', 'fc6');
	%evaluate1('tv2007', 'p12q1n2c1', 'p12b', 'fc7');
	%evaluate1('tv2007', 'p12q1n2c1', 'p12b', 'fc8');	
	%evaluate1('tv2001', 'p12q1n2c1', 'p12b', 'pool5');
	%evaluate1('tv2001', 'p12q1n2c1', 'p12b', 'fc6');
	%evaluate1('tv2001', 'p12q1n2c1', 'p12b', 'fc7');
	%evaluate1('tv2001', 'p12q1n2c1', 'p12b', 'fc8');
	%evaluate1('tv2007', 'p12q1n2c0', 'p12b', 'pool5');
	%evaluate1('tv2007', 'p12q1n2c0', 'p12b', 'fc6');
	%evaluate1('tv2007', 'p12q1n2c0', 'p12b', 'fc7');
	%evaluate1('tv2007', 'p12q1n2c0', 'p12b', 'fc8');
	%evaluate1('tv2001', 'p12q1n2c0', 'p12b', 'pool5');	
	%evaluate1('tv2001', 'p12q1n2c0', 'p12b', 'fc6');
	%evaluate1('tv2001', 'p12q1n2c0', 'p12b', 'fc7');
	%evaluate1('tv2001', 'p12q1n2c0', 'p12b', 'fc8');
	%evaluate1('tv2007', 'p12n1c1', 'p12b', 'pool5');
	%evaluate1('tv2007', 'p12n1c1', 'p12b', 'fc6');
	%evaluate1('tv2007', 'p12n1c1', 'p12b', 'fc7');
	%evaluate1('tv2007', 'p12n1c1', 'p12b', 'fc8');
	%evaluate1('tv2001', 'p12n1c1', 'p12b', 'pool5');	
	%evaluate1('tv2001', 'p12n1c1', 'p12b', 'fc6');
	%evaluate1('tv2001', 'p12n1c1', 'p12b', 'fc7');
	%evaluate1('tv2001', 'p12n1c1', 'p12b', 'fc8');


	%evaluate1('tv2001', 'deepSBD', 'p12b', 'fc8');
    %evaluate1('tv2001', 'deepSBD', 'p12b', 'fc7');
    %evaluate1('tv2001', 'deepSBD', 'p12b', 'fc6');
    %evaluate1('tv2007', 'deepSBD', 'p12b', 'fc8');
    %evaluate1('tv2007', 'deepSBD', 'p12b', 'fc7');
    %evaluate1('tv2007', 'deepSBD', 'p12b', 'fc6');
    
    %evaluate1('tv2006', 'deepSBD', 'p12b', 'fc8');
    %evaluate1('tv2006', 'deepSBD', 'p12b', 'fc7');
    %evaluate1('tv2006', 'deepSBD', 'p12b', 'fc6');
    
    %evaluate1('tv2002', 'dsbdn6', 'p12b', 'prob');
    %evaluate1('tv2002', 'dsbdn6', 'p12b', 'fc8');
    %evaluate1('tv2002', 'dsbdn6', 'p12b', 'fc7');
    %evaluate1('tv2002', 'dsbdn6', 'p12b', 'fc6');

    %evaluate1('tv2001_v2', 'dsbdn6', 'p12b', 'fc8');
    %evaluate1('tv2001_v2', 'dsbdn6', 'p12b', 'prob');
    %evaluate1('tv2001_v2', 'dsbdn6', 'p12b', 'fc7');
    %evaluate1('tv2001_v2', 'dsbdn6', 'p12b', 'fc6');
   
    %evaluate1('tv2001', 'dsbdn6', 'p12b', 'fc8');
    %evaluate1('tv2001', 'dsbdn6', 'p12b', 'fc7');


    %evaluate1('tv2006', 'dsbdn6', 'p12b', 'fc8');
    %evaluate1('tv2006', 'dsbdn6', 'p12b', 'fc7');
    %evaluate1('tv2006', 'dsbdn6', 'p12b', 'fc6');

    %evaluate1('tv2003', 'dsbdn6', 'p12b', 'fc8');
    %evaluate1('tv2003', 'dsbdn6', 'p12b', 'fc7');
    %evaluate1('tv2003', 'dsbdn6', 'p12b', 'fc6');

	%evaluate1('tv2004', 'dsbdn6', 'p12b', 'fc8');
    %evaluate1('tv2004', 'dsbdn6', 'p12b', 'fc7');
    %evaluate1('tv2004', 'dsbdn6', 'p12b', 'fc6');


    %evaluate1('tv2007', 'dsbdn6', 'p12b', 'fc8');
    %evaluate1('tv2007', 'dsbdn6', 'p12b', 'fc7');

    %evaluate1('tv2007', 'dsbdn6', 'p12b', 'prob');
    %evaluate1('tv2001', 'dsbdn6', 'p12b', 'prob');
    %evaluate1('tv2006', 'dsbdn6', 'p12b', 'prob');
		
	%evaluate1('soccoer_video', 'dsbdn6', 'p12b', 'fc8');
	
	%evaluate1('tv2001', 'clstmstp', 'p12b', 'lstm1-drop');
	%evaluate1('tv2007', 'clstmstp', 'p12b', 'lstm1-drop');
	%evaluate1('tv2006', 'clstmstp', 'p12b', 'lstm1-drop');

	%evaluate1('tv2001', 'clstmstp', 'p12b', 'fc8');
	%evaluate1('tv2007', 'clstmstp', 'p12b', 'fc8');
	%evaluate1('tv2006', 'clstmstp', 'p12b', 'fc8');

	%evaluate1('tv2001', 'clstmstp', 'p12b', 'fc7');
	%evaluate1('tv2007', 'clstmstp', 'p12b', 'fc7');
	%evaluate1('tv2006', 'clstmstp', 'p12b', 'fc7');


	%evaluate1('tv2001', 'adadelta', 'p12b', 'fc8');
	%evaluate1('tv2007', 'adadelta', 'p12b', 'fc8');
	%evaluate1('tv2006', 'adadelta', 'p12b', 'fc8');

	%evaluate1('tv2001', 'p12wub3', 'p12b', 'fc8');
	%evaluate1('tv2006', 'p12wub3', 'p12b', 'fc8');


	%evaluate1('tv2001', 'p145x5x3', 'p12b', 'prob');
	%evaluate1('tv2007', 'p145x5x3', 'p12b', 'prob');
	
	%evaluate1('tv2001', 'p135x5x3', 'p12b', 'prob');
	%evaluate1('tv2007', 'p135x5x3', 'p12b', 'prob');


	%evaluate1('tv2006', 'dsbdn6', 'p12b', 'prob');

 

    %evaluate1('tv2006', 'dsbdn6', 'p12b', 'fc8');

	%evaluate1('tv2006', 'dsbdn6', 'p12b', 'prob');
    %evaluate1('tv2007', 'dsbdn6', 'p12b', 'prob');
    %evaluate1('tv2001', 'dsbdn6', 'p12b', 'prob');
	

	%evaluate1('tv2006', 'dsbdn64', 'p12b', 'fc8');
    %evaluate1('tv2007', 'dsbdn64', 'p12b', 'fc8');
    %evaluate1('tv2001', 'dsbdn64', 'p12b', 'fc8');

	%evaluate1('tv2006', 'dsbdn64', 'p12b', 'prob');
    %evaluate1('tv2007', 'dsbdn64', 'p12b', 'prob');
    %evaluate1('tv2001', 'dsbdn64', 'p12b', 'prob');


	%evaluate1('tv2006', 'dsbdn642', 'p12b', 'prob');
    %evaluate1('tv2007', 'dsbdn642', 'p12b', 'prob');
    %evaluate1('tv2001', 'dsbdn642', 'p12b', 'prob');


	%evaluate1('tv2006', 'dsbdn632', 'p12b', 'prob');
    %evaluate1('tv2007', 'dsbdn632', 'p12b', 'prob');
    %evaluate1('tv2001', 'dsbdn632', 'p12b', 'prob');

	%evaluate1('tv2006', 'dsbdn632', 'p16a', 'fc8');
    %evaluate1('tv2007', 'dsbdn632', 'p16a', 'fc8');
    %evaluate1('tv2001', 'dsbdn632', 'p16a', 'fc8');

    %evaluate3('ucf101', 'dsbdn642', 'p12b', 'prob');
    %evaluate3('ucf101', 'dsbdn6', 'p12b', 'prob');
    %evaluate3('ucf101', 'dsbdn6', 'p12b', 'prob');

    %evaluate1('tv2001', 'dsbdn63', 'p12b', 'fc8');
    %evaluate1('tv2006', 'dsbdn63', 'p12b', 'fc8');	
    %evaluate1('tv2007', 'dsbdn63', 'p12b', 'fc8');
	
	%evaluate1('tv2001', 'alex2', 'p12b', 'fc8');
    %evaluate1('tv2001', 'alex2', 'p12b', 'fc7');
    %evaluate1('tv2001', 'alex2', 'p12b', 'fc6');
    %evaluate1('tv2007', 'alex2', 'p12b', 'fc8');
    %evaluate1('tv2007', 'alex2', 'p12b', 'fc7');
    %evaluate1('tv2007', 'alex2', 'p12b', 'fc6');
    

    %evaluate1('tv2001', 'p12w40n4c2', 'p12b', 'fc8');
    %evaluate1('tv2001', 'p12w40n4c2', 'p12b', 'fc7');
    %evaluate1('tv2001', 'p12w40n4c2', 'p12b', 'fc6');
    %evaluate1('tv2001', 'p12w40n4c2', 'p12b', 'pool5');
    %evaluate1('tv2007', 'p12w40n4c2', 'p12b', 'fc8');
    %evaluate1('tv2007', 'p12w40n4c2', 'p12b', 'fc7');
    %evaluate1('tv2007', 'p12w40n4c2', 'p12b', 'fc6');
    %evaluate1('tv2007', 'p12w40n4c2', 'p12b', 'pool5');
    %evaluate1('tv2001', 'p12w40n4c1', 'p12b', 'fc8');
    %evaluate1('tv2001', 'p12w40n4c1', 'p12b', 'fc7');
    %evaluate1('tv2001', 'p12w40n4c1', 'p12b', 'fc6');
    %evaluate1('tv2001', 'p12w40n4c1', 'p12b', 'pool5');
    %evaluate1('tv2007', 'p12w40n4c1', 'p12b', 'fc8');
    %evaluate1('tv2007', 'p12w40n4c1', 'p12b', 'fc7');
    %evaluate1('tv2007', 'p12w40n4c1', 'p12b', 'fc6');
    %evaluate1('tv2007', 'p12w40n4c1', 'p12b', 'pool5');
    evaluate1('tv2001', 'p12w1n1c0', 'p12b', 'fc8');
    %evaluate1('tv2001', 'p12w1n1c0', 'p12b', 'fc7');
    %evaluate1('tv2001', 'p12w1n1c0', 'p12b', 'fc6');
    %evaluate1('tv2001', 'p12w1n1c0', 'p12b', 'pool5');
    %evaluate1('tv2007', 'p12w1n1c0', 'p12b', 'fc8');
    %evaluate1('tv2007', 'p12w1n1c0', 'p12b', 'fc7');
    %evaluate1('tv2007', 'p12w1n1c0', 'p12b', 'fc6');
    %evaluate1('tv2007', 'p12w1n1c0', 'p12b', 'pool5');

end 
%% functionname: function description
function f = evaluate3(dataset, model_name, set_name, feature_name)

	c_type = 'segments_no_overlap0'; %'segments0'
	c_type = 'test';
	%if strcmp(model_name, 'dsbdn6'),
	%c_type = '';
	%end
	resDir = strcat('/data/mamdouh/ucf101/Wipe_Detector/scores/');
	fprintf('dataset: %s\tmodel: %s\t feature: %s\n', dataset, model_name, feature_name);
	gradual_scores = fopen(strcat(resDir, 'gradual_scores.txt'), 'w');
	sharp_scores = fopen(strcat(resDir, 'sharp_scores.txt'), 'w');
	wipe_scores = fopen(strcat(resDir, 'wipe_scores.txt'), 'w');
	for threshold=-0.1:0.05:3
		fprintf('threshold %1.2f\n', threshold);

		dir_name = strcat('/', model_name, '/', set_name, '/', feature_name);
		matDir = strcat(dataset, dir_name, '/mats', c_type, '/');
		resDir = strcat(dataset, dir_name, '/results_without_norm', c_type, '/', num2str(threshold, '%1.2f'), '/');

		[gradual_line, sharp_line, wipe_line] = evaluate4(resDir, matDir, threshold);
		fprintf(gradual_scores, gradual_line);
		fprintf(sharp_scores, sharp_line);
		fprintf(wipe_scores, wipe_line);
	end
	fclose(gradual_scores);
	fclose(sharp_scores);
	fclose(wipe_scores);
end
function [gradual_line, sharp_line, wipe_line] = evaluate4(resDir, matDir, threshold)
	if ~exist(resDir, 'dir')
		mkdir(resDir)
	end
	wipes_v2 = fopen(strcat(resDir, 'wipes_v2.txt'), 'w');

	confusionMat = zeros(4,4);
	files = dir(matDir);
	files = files(3:end);
	for f=1:size(files,1)
		filename = files(f).name;
		filename = sprintf('%02d', f-1);
		pt = fopen(strcat(resDir, filename, '.pt'), 'w');

		%disp(filename);
		mats = strcat(matDir, filename, '/');
		plabels_file = strcat(mats, 'predicted_labels.mat');
		if ~exist(plabels_file, 'file')
			fprintf('already predicted %s', plabels_file)
			continue;
		end
		predicted_labels = load(plabels_file);
		predicted_labels = predicted_labels.predicted_labels;

		testing_labels = load(strcat(mats, 'testing_labels.mat'));
		testing_labels = testing_labels.testing_labels;

		starting_frame = load(strcat(mats, 'starting_frame.mat'));
		starting_frame = starting_frame.starting_frame;
		files_paths_file = strcat(mats, 'files_paths.mat');
		if exist(files_paths_file, 'file')
			files_paths = load(files_paths_file);
			files_paths = files_paths.files_paths;
		else
			files_paths = [];
		end
		decision_values = load(strcat(mats, 'decision_values.mat'));
		decision_values = decision_values.decision_values;
		
		total = size(testing_labels,1);

		for i=1:total
			%if mod(i, 10000) == 0
			%	fprintf('iteration: %d/%d\n', i, total);
			%end
			predicted = predicted_labels(i)+1;
			groundtruth = testing_labels(i)+1;
			confidence=max(decision_values(i,:));

			if confidence<=threshold && threshold >= 0 				
				predicted = 1;
			end
			confusionMat(predicted, groundtruth) = confusionMat(predicted, groundtruth) + 1;
			fprintf(pt, '%d\t%d\t%d\t%d\t%d\t%f\t%s\n',i, starting_frame(i), starting_frame(i)+2*8, predicted, groundtruth, 1, files_paths{i});
			if groundtruth == 1 || groundtruth == 4 || predicted == 1 || predicted == 4
				fprintf(wipes_v2, '%s %d %d\n', files_paths{i}, starting_frame(i), groundtruth - 1);
			end

			
		end
		fclose(pt);

	end

	precision = @(confusionMat) diag(confusionMat)./sum(confusionMat,2);
    recall = @(confusionMat) diag(confusionMat)./sum(confusionMat,1)';
    f1Scores = @(confusionMat) 2*(precision(confusionMat).*recall(confusionMat))./(precision(confusionMat)+recall(confusionMat));
    meanF1 = @(confusionMat) mean(f1Scores(confusionMat));
    p = precision(confusionMat);
    r = recall(confusionMat);
    f = f1Scores(confusionMat);
    meanF1(confusionMat);
    disp(confusionMat);
    gradual_line = sprintf('%f\t%f\t%f\n', p(2), r(2), f(2));
    sharp_line = sprintf('%f\t%f\t%f\n', p(3), r(3), f(3));
    wipe_line = sprintf('%f\t%f\t%f\n', p(4), r(4), f(4));
	fclose(wipes_v2);
end

function f = evaluate1(dataset, model_name, set_name, feature_name)
	%filename = '03'
	%dataset = 'tv2001';
	%model_name = 'p5'
	%set_name = 'p6b'
	c_type = 'segments_no_overlap0'; %'segments0'
	c_type = 'segments0';
	%if strcmp(model_name, 'dsbdn6'),
	%c_type = '';
	%end
	fprintf('dataset: %s\tmodel: %s\t feature: %s\n', dataset, model_name, feature_name);
	for threshold=-0.1:0.05:3
		fprintf('threshold %1.2f\n', threshold);
		%if threshold~=-0.1
		%	continue;
		%end
		dir_name = strcat('/', model_name, '/', set_name, '/', feature_name);
		matDir = strcat(dataset, dir_name, '/mats_normalized/');
		resDir = strcat(dataset, dir_name, '/results_with_norm/', num2str(threshold, '%1.2f'), '/');
		%evaluate2(resDir, matDir, threshold);

		matDir = strcat(dataset, dir_name, '/mats', c_type, '/');
		resDir = strcat(dataset, dir_name, '/results_without_norm', c_type, '/', num2str(threshold, '%1.2f'), '/');
		evaluate2(resDir, matDir, threshold);
	end
end
function evaluate2(resDir, matDir, threshold)
	files = dir(matDir);
	files = files(3:end);
	if ~exist(resDir, 'dir')
		mkdir(resDir);
	%else 
	%	return;
	end
	%mkdir(matDir);
	for f=1:size(files,1)
		filename = files(f).name;
		filename = sprintf('%02d', f-1);

		%disp(filename);

		mats = strcat(matDir, filename, '/');

		%labels_file = fopen([dataset '/8overlapSegments/' dataset '_unbal_testlist_' filename '.txt'],'r');
		

		%testing_labels = textscan(labels_file,'%s %d %d\n');
		%fnames = testing_labels{1};

		%fclose(labels_file);
		%testing_labels = testing_labels{3};
		step = 8;
		MULT = 1;
		plabels_file = strcat(mats, 'predicted_labels.mat');
		if ~exist(plabels_file, 'file')
			fprintf('already predicted %s', plabels_file)
			continue;
		end
		predicted_labels = load(plabels_file);
		predicted_labels = predicted_labels.predicted_labels;
		confusionMat = zeros(5,5);

		testing_labels = load(strcat(mats, 'testing_labels.mat'));
		testing_labels = testing_labels.testing_labels;

		starting_frame = load(strcat(mats, 'starting_frame.mat'));
		starting_frame = starting_frame.starting_frame;
		files_paths_file = strcat(mats, 'files_paths.mat');
		if exist(files_paths_file, 'file')
			files_paths = load(files_paths_file);
			files_paths = files_paths.files_paths;
		else
			files_paths = [];
		end


		decision_values = load(strcat(mats, 'decision_values.mat'));
		decision_values = decision_values.decision_values;

		%datasets = load(strcat(mats, 'datasets.mat'));
		%datasets = datasets.datasets;

		%videos_name = load(strcat(mats, 'videos_name.mat'));
		%videos_name = videos_name.videos_name;
		pt = fopen(strcat(resDir, filename, '.pt'), 'w');

		total = size(testing_labels,1);
		%if total == 0
		%	continue;
		%end
		prv_frame = starting_frame(1);
		prv_label = predicted_labels(1) + 1;
		prv_confidence = max(decision_values(1, :));
		st_normal = [];
		ed_normal = [];
		
		st_soft = [];
		ed_soft = [];
		
		st_sharp = [];
		ed_sharp = [];
		
		st_wipe = [];
		ed_wipe = [];
		
		normal_confidence=[];
		soft_confidence=[];
		sharp_confidence=[];
		wipe_confidence=[];
		
		normal_datasets=[];
		soft_datasets=[];
		sharp_datasets=[];

		normal_videosname=[];
		soft_videosname=[];
		sharp_videosname=[];



		for i=1:total-MULT+1
			%if mod(i, 2) == 0
			%	continue;
			%end
			%if mod(i, 10000) == 0
			%	fprintf('iteration: %d/%d\n', i, total);
			%end

			predicted = predicted_labels(i)+1;
			groundtruth = testing_labels(i)+1;
			confusionMat(predicted, groundtruth) = confusionMat(predicted, groundtruth) + 1;
			confidence=max(decision_values(i,:));
			%disp((decision_values(i,:)))
			%disp(confidence);
			%if predicted == 2 && confidence<threshold && threshold >= 0 % If I am not so sure about whether it is soft transition or not I set it to background
			%	if decision_values(i, 1) > decision_values(i, 3)
			%		predicted=1;
			%	end
			%end
			%if predicted == 3 && confidence<threshold && threshold >= 0 % If I am not so sure about whether it is soft transition or not I set it to background
			%	if decision_values(i, 1) > decision_values(i, 2)
			%		predicted=1;
			%	end
			%end
			if confidence<=threshold && threshold >= 0 % If I am not so sure about whether it is soft transition or not I set it to background
				
				predicted = 1;
			end
			%if confidence<threshold && predicted == 1
			%	if decision_values(i, 2) > decision_values(i, 3)
			%		predicted = 2;
			%	else
			%		predicted = 3;
			%	end
			%%elseif confidence<threshold && predicted == 3
			%%	if decision_values(i, 2) > decision_values(i, 1)
			%%		predicted = 2;
			%%	%else:
			%%	%	predicted = 3;
			%%	end
			%end
			if isempty(files_paths)
				fprintf(pt, '%d\t%d\t%d\t%d\t%d\t%f\n',i, starting_frame(i), starting_frame(i)+2*step, predicted, groundtruth, confidence);
			else
				
				fprintf(pt, '%d\t%d\t%d\t%d\t%d\t%f\t%s\n',i, starting_frame(i), starting_frame(i)+2*step, predicted, groundtruth, confidence, files_paths{i});
			end
			%continue;
			nxt_frame = starting_frame(i);
			%fprintf('%d - %d\t%d\n', nxt_frame, nxt_frame+step, predicted);
			if prv_label~=predicted %|| strcmp(videos_name{i}, videos_name{i-1})==0 || starting_frame(i)>starting_frame(i-1)+2*step %|| predicted == 3
				%prv_label = predicted;
				end_frame = nxt_frame+step*MULT;
				%if prv_label~=1
				%fprintf(resutls, '%d\t%d\t%d\n', prv_frame, end_frame, prv_label);
				%end
				if prv_label == 1
					st_normal(end+1) = prv_frame;
					ed_normal(end+1) = end_frame;
					normal_confidence(end+1) = prv_confidence;
					%normal_datasets{end+1} = datasets{i-1};
					%normal_videosname{end+1} = videos_name{i-1};
				elseif prv_label == 2
					st_soft(end+1) = prv_frame;
					ed_soft(end+1) = end_frame;
					soft_confidence(end+1) = prv_confidence;
					%soft_datasets{end+1} = datasets{i-1};
					%soft_videosname{end+1} = videos_name{i-1};
				elseif prv_label == 3
					st_sharp(end+1) = prv_frame;
					ed_sharp(end+1) = end_frame;
					sharp_confidence(end+1) = prv_confidence;
					%sharp_datasets{end+1} = datasets{i-1};
					%sharp_videosname{end+1} = videos_name{i-1};

				elseif prv_label == 4
					st_wipe(end+1) = prv_frame;
					ed_wipe(end+1) = end_frame;
					wipe_confidence(end+1) = prv_confidence;

				end
				prv_label = predicted;
				prv_frame = nxt_frame;
				prv_confidence=confidence;
			end
			prv_confidence = max(prv_confidence, confidence);
			%prv_label=-1;
		end

		fclose(pt);
		%continue;
		resutls = fopen(strcat(resDir, filename, '.txt'), 'w');
		%fprintf('normal iterations %d\n', size(st_normal,2));
		for i=1:size(st_normal, 2)
			%if mod(i, 1000) == 0
			%	fprintf('normal iteration: %d/%d\n', i, size(st_normal, 2));
			%end
			fprintf(resutls, '%d\t%d\t%d\n', st_normal(i), ed_normal(i), 1);
		end
		%fprintf('soft iterations %d\n', size(st_soft,2));
		for i=1:size(st_soft, 2)
			%if mod(i, 1000) == 0
			%	fprintf('soft iteration: %d/%d\n', i, size(st_soft, 2));
			%end
			fprintf(resutls, '%d\t%d\t%d\n', st_soft(i), ed_soft(i), 2);
		end
		%fprintf('sharp iterations %d\n', size(st_sharp,2));
		for i=1:size(st_sharp, 2)
			%if mod(i, 1000) == 0
			%	fprintf('sharp iteration: %d/%d\n', i, size(st_sharp, 2));
			%end
			fprintf(resutls, '%d\t%d\t%d\n', st_sharp(i), ed_sharp(i), 3);
		end
		%disp(size(st_wipe, 2));
		for i=1:size(st_wipe, 2)
			fprintf(resutls, '%d\t%d\t%d\n', st_wipe(i), ed_wipe(i), 4);
		end

		fclose(resutls);

		[st_normal, ed_normal, normal_confidence] = merge_segs(st_normal, ed_normal, normal_confidence, 0);
		[st_soft, ed_soft, soft_confidence] = merge_segs(st_soft, ed_soft, soft_confidence, 0);
		
		%[st_sharp, ed_sharp, sharp_confidence] = merge_segs(st_sharp, ed_sharp, sharp_confidence, 0);

		%[st_soft, ed_soft, soft_confidence] = delete_contained(st_normal, ed_normal, st_soft, ed_soft, soft_confidence);
		[st_normal, ed_normal, normal_confidence] = delete_contained(st_soft, ed_soft, st_normal, ed_normal, normal_confidence);

		%[st_soft, ed_soft] = delete_contained(st_sharp, ed_sharp, st_soft, ed_soft);
		%[st_sharp, ed_sharp] = delete_contained(st_soft, ed_soft, st_sharp, ed_sharp);


		resutls_nms = fopen(strcat(resDir, filename, '.nms'), 'w');
		%disp(normal_datasets);
		for i=1:size(st_normal, 2)
			%disp(i);
			%disp(normal_datasets{i}{1})
			%if mod(i, 1000) == 0
			%	fprintf('NMS normal iteration: %d/%d\n', i, size(st_normal, 2));
			%end
			%fprintf(resutls_nms, '%d\t%d\t%d\t%0.5f\t%s\t%s\n', st_normal(i), ed_normal(i), 1, normal_confidence(i), normal_datasets{i}{1}, normal_videosname{i}{1});
			fprintf(resutls_nms, '%d\t%d\t%d\t%0.5f\n', st_normal(i), ed_normal(i), 1, normal_confidence(i));
		end
		for i=1:size(st_soft, 2)
			%if mod(i, 1000) == 0
			%	fprintf('NMS soft iteration: %d/%d\n', i, size(st_soft, 2));
			%end
			%if soft_confidence(i)>0 && ed_soft(i) - st_soft(i) > 16
				%fprintf(resutls_nms, '%d\t%d\t%d\t%0.5f\t%s\t%s\n', st_soft(i), ed_soft(i), 2, soft_confidence(i), soft_datasets{i}{1}, soft_videosname{i}{1});
				fprintf(resutls_nms, '%d\t%d\t%d\t%0.5f\n', st_soft(i), ed_soft(i), 2, soft_confidence(i));
			%end
		end
		for i=1:size(st_sharp, 2)
			%if mod(i, 1000) == 0
			%	fprintf('NMS sharp iteration: %d/%d\n', i, size(st_sharp, 2));
			%end
			%fprintf(resutls_nms, '%d\t%d\t%d\t%0.5f\t%s\t%s\n', st_sharp(i), ed_sharp(i), 3, sharp_confidence(i), sharp_datasets{i}{1}, sharp_videosname{i}{1});
			fprintf(resutls_nms, '%d\t%d\t%d\t%0.5f\n', st_sharp(i), ed_sharp(i), 3, sharp_confidence(i));
		end
		for i=1:size(st_wipe, 2)
			fprintf(resutls_nms, '%d\t%d\t%d\t%0.5f\n', st_wipe(i), ed_wipe(i), 4, wipe_confidence(i));
		end
		
		fclose(resutls_nms);

	    %precision = @(confusionMat) diag(confusionMat)./sum(confusionMat,2);
	    %recall = @(confusionMat) diag(confusionMat)./sum(confusionMat,1)';
	    %f1Scores = @(confusionMat) 2*(precision(confusionMat).*recall(confusionMat))./(precision(confusionMat)+recall(confusionMat));
	    %meanF1 = @(confusionMat) mean(f1Scores(confusionMat));
	    %p = precision(confusionMat)
	    %r = recall(confusionMat)
	    %f = f1Scores(confusionMat)
	    %meanF1(confusionMat)
	    %disp(confusionMat);
	end

end
function [st, ed, cnf] = merge_segs(st, ed, cnf, margin)

	i=2;
	%fprintf('Merge %d\n', size(st,2))
	while i<=size(st, 2)
		if ed(i-1)+margin>=st(i)-margin
			ed(i-1) = max(ed(i), ed(i-1));
			cnf(i-1) = (cnf(i) + cnf(i-1));
			st(i) = [];
			ed(i) = [];
			cnf(i) = [];
			%ds(i)=[];
			%vn(i)=[];
			%fprintf('%d\n', size(st,2));
			%if mod(i, 1000) == 0
			%	fprintf('Merge iteration: %d/%d\n', i, size(st, 2));
			%end
		else
			i=i+1;
		end
	end
end

function [st_b, ed_b, cnf_b] = delete_contained(st_a, ed_a, st_b, ed_b, cnf_b)
	%fprintf('Delete %d\n', size(st_a,2))
	for i=1:size(st_a, 2)
		x1 = st_a(i);
		x2 = ed_a(i);
		%if mod(i, 1000) == 0
		%	fprintf('Delete iteration: %d/%d\n', i, size(st_a, 2));
		%end
		%k_st = 1;
		%k_ed = size(st_b, 2);
		%while(k_st<k_ed)
		%	k_md = k_st + (k_ed-k_st)/2;
		%	y1 = st_b(k_md);
		%	if(y1>=x1)
		%		k_ed = k_md;
		%	else
		%		k_st = k_md+1;
		%	end
		%end
		%j_st = k_st;
		%
		%k_st = 1;
		%k_ed = size(st_b, 2);
		%
		%while(k_st<k_ed)
		%	k_md = k_st + (k_ed-k_st)/2;
		%	y2 = ed_b(k_md);
		%	if(y2>=x2)
		%		k_ed = k_md;
		%	else
		%		k_st = k_md+1;
		%	end
		%end

		for j=1:size(st_b, 2)
			y1 = st_b(j);
			y2 = ed_b(j);
			if y1>=x1 && y2<=x2
				st_b(j)=-1;
				ed_b(j)=-1;
				cnf_b(j)=-1;
				%ds_b{j}='-1';
				%vn_b{j}='-1';
			end
		end
	end
	st_b = st_b(st_b~=-1);
	ed_b = ed_b(ed_b~=-1);
	cnf_b = cnf_b(cnf_b~=-1);
	%ds_b = ds_b(strcmp(ds_b, '-1')==0);
	%vn_b = vn_b(strcmp(vn_b, '-1')==0);
end

